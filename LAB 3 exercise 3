#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <util/delay.h>

volatile uint8_t tickCount = 0;   // Timer0 tick counter
volatile uint8_t ledOn = 0;       // LED timing flag

// Timer1 ISR: runs once per second
ISR(TIMER1_COMPA_vect) {
  PORTB |= (1 << PB5); // LED on
  tickCount = 0;
  ledOn = 1;
}

// Timer0 ISR: runs every 1 ms to turn LED off after 100 ms
ISR(TIMER0_COMPA_vect) {
  if (ledOn) {
    tickCount++;
    if (tickCount >= 100) {
      PORTB &= ~(1 << PB5); // LED off
      ledOn = 0;
    }
  }
}

int main(void) {
  DDRB |= (1 << PB5); // Pin 13 output

  // Timer0 setup
  TCCR0A |= (1 << WGM01);              // CTC mode
  TCCR0B |= (1 << CS00) | (1 << CS01); // Prescaler 64
  TIMSK0 |= (1 << OCIE0A);             // Enable compare interrupt
  OCR0A = 249;

  // Timer1 setup
  TCCR1B |= (1 << WGM12);              // CTC mode
  OCR1A = 15624;                       // 1s interval
  TCCR1B |= (1 << CS12) | (1 << CS10); // Prescaler 1024
  TIMSK1 |= (1 << OCIE1A);             // Enable compare interrupt

  sei();
  set_sleep_mode(SLEEP_MODE_IDLE);

  while (1) {
    sleep_mode(); // Sleep until interrupt
  }
}
